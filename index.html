<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Neurones Noirs - Parkour 3D</title>
  <script src="https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background: #000;
      touch-action: none;
      user-select: none;
    }
    #ui {
      position: absolute;
      top: 15px;
      left: 15px;
      color: #0ff;
      font-size: 26px;
      font-weight: bold;
      text-shadow: 0 0 10px #0ff, 0 0 20px #0ff;
      pointer-events: none;
      z-index: 10;
    }
    #highScore {
      position: absolute;
      top: 45px;
      left: 15px;
      color: #ffd700;
      font-size: 20px;
      text-shadow: 0 0 5px #ffd700;
      pointer-events: none;
      z-index: 10;
    }
    #gameOver {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #f00;
      font-size: 70px;
      font-weight: bold;
      text-align: center;
      text-shadow: 0 0 20px #f00;
      display: none;
      z-index: 15;
    }
    #gameOver span {
      font-size: 40px;
      color: #ff0;
      display: block;
      margin: 20px 0;
    }
    #restartBtn {
      margin-top: 40px;
      padding: 18px 60px;
      font-size: 32px;
      background: #0f0;
      color: #000;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 0 20px #0f0;
    }
    #shopBtn {
      position: absolute;
      top: 15px;
      right: 15px;
      padding: 10px 20px;
      background: #00f;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 22px;
      cursor: pointer;
      z-index: 10;
      box-shadow: 0 0 15px #00f;
    }
    #shop {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      padding: 30px;
      border: 3px solid #0f0;
      border-radius: 15px;
      color: #0f0;
      text-align: center;
      display: none;
      z-index: 20;
      max-width: 400px;
    }
    #shop h2 {
      margin-bottom: 20px;
    }
    #shop button {
      margin: 10px;
      padding: 12px 24px;
      background: #0f0;
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #closeShop {
      background: #f00;
      color: #fff;
    }
    #jumpBtn {
      position: fixed;
      bottom: 60px;
      right: 60px;
      width: 110px;
      height: 110px;
      background: rgba(255, 100, 0, 0.8);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 55px;
      font-weight: bold;
      z-index: 5;
      touch-action: manipulation;
      box-shadow: 0 0 25px #ff6000;
    }
    #jumpBtn:active {
      transform: scale(0.92);
      background: rgba(255, 140, 0, 1);
    }
  </style>
</head>
<body>

  <div id="ui">Coins: <span id="coins">0</span> | Score: <span id="score">0</span></div>
  <div id="highScore">High: <span id="high">0</span></div>
  <button id="shopBtn">Shop</button>

  <div id="gameOver">
    GAME OVER
    <span id="finalScore">Score: 0</span>
    <button id="restartBtn">Rejouer</button>
  </div>

  <div id="shop">
    <h2>Skins</h2>
    <div id="skinsList"></div>
    <button id="closeShop">Fermer</button>
  </div>

  <button id="jumpBtn">↑</button>

  <!-- Sons -->
  <audio id="jumpSound" src="https://freesound.org/data/previews/331/331899_3248244-lq.mp3"></audio> <!-- Son saut gratuit -->
  <audio id="collectSound" src="https://freesound.org/data/previews/270/270404_5004521-lq.mp3"></audio> <!-- Son pièce -->
  <audio id="crashSound" src="https://freesound.org/data/previews/191/191697_2436353-lq.mp3"></audio> <!-- Son crash -->

<script>
// ────────────────────────────────────────────────
// CLASSES MODULAIRES – Améliorées (sons, particules, shop, variété obstacles, highscore)
// ────────────────────────────────────────────────

class Game {
  constructor() {
    this.scene = null;
    this.camera = null;
    this.renderer = null;
    this.player = null;
    this.track = null;
    this.obstacles = [];
    this.collectibles = [];
    this.particles = [];
    this.score = 0;
    this.highScore = localStorage.getItem('nn_high') ? parseInt(localStorage.getItem('nn_high')) : 0;
    this.coins = localStorage.getItem('nn_coins') ? parseInt(localStorage.getItem('nn_coins')) : 0;
    this.currentSkin = localStorage.getItem('nn_skin') || 'default';
    this.gameOver = false;
    this.speed = 0.18;
    this.clock = new THREE.Clock();

    document.getElementById('coins').textContent = this.coins;
    document.getElementById('high').textContent = this.highScore;
  }

  init() {
    this.scene = new THREE.Scene();
    this.scene.background = new THREE.Color(0x0a0015);
    this.scene.fog = new THREE.FogExp2(0x0a0015, 0.0012);

    this.camera = new THREE.PerspectiveCamera(65, window.innerWidth / window.innerHeight, 0.1, 2000);
    this.camera.position.set(0, 6, 14);

    this.renderer = new THREE.WebGLRenderer({ antialias: true });
    this.renderer.setSize(window.innerWidth, window.innerHeight);
    this.renderer.shadowMap.enabled = true;
    document.body.appendChild(this.renderer.domElement);

    const ambient = new THREE.AmbientLight(0xffffff, 0.5);
    this.scene.add(ambient);

    const dirLight = new THREE.DirectionalLight(0xffccaa, 1.4);
    dirLight.position.set(15, 30, 10);
    dirLight.castShadow = true;
    this.scene.add(dirLight);

    this.player = new Player(this.scene, this.currentSkin);
    this.track = new Track(this.scene);

    this.setupControls();
    this.setupSwipe();
    this.setupShop();

    this.animate();
  }

  setupControls() {
    document.getElementById('jumpBtn').addEventListener('pointerdown', (e) => {
      e.preventDefault();
      if (!this.gameOver) {
        this.player.jump();
        document.getElementById('jumpSound').play();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (this.gameOver) return;
      if (e.code === 'Space' || e.code === 'ArrowUp') {
        e.preventDefault();
        this.player.jump();
        document.getElementById('jumpSound').play();
      }
      if (e.code === 'ArrowLeft' && this.player.lane > -1) this.player.lane--;
      if (e.code === 'ArrowRight' && this.player.lane < 1) this.player.lane++;
    });

    document.getElementById('restartBtn').addEventListener('click', () => this.reset());
  }

  setupSwipe() {
    let touchStartX = 0;
    let touchStartY = 0;

    document.addEventListener('touchstart', (e) => {
      if (this.gameOver) return;
      if (e.touches.length === 1) {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
      }
    }, { passive: false });

    document.addEventListener('touchmove', (e) => {
      if (this.gameOver) return;
      e.preventDefault();
    }, { passive: false });

    document.addEventListener('touchend', (e) => {
      if (this.gameOver) return;
      if (e.changedTouches.length === 1) {
        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;

        const dx = touchEndX - touchStartX;
        const dy = touchEndY - touchStartY;

        if (Math.abs(dx) > 60 && Math.abs(dx) > Math.abs(dy)) {
          if (dx > 0 && this.player.lane < 1) this.player.lane++;
          if (dx < 0 && this.player.lane > -1) this.player.lane--;
        } else if (Math.abs(dy) > 80 && Math.abs(dy) > Math.abs(dx)) {
          if (dy < 0) {
            this.player.jump();
            document.getElementById('jumpSound').play();
          }
        }
      }
    }, { passive: false });
  }

  setupShop() {
    const skins = [
      { id: 'default', name: 'Jaune', color: 0xffea00, price: 0 },
      { id: 'red', name: 'Rouge', color: 0xff0000, price: 50 },
      { id: 'blue', name: 'Bleu', color: 0x0000ff, price: 100 },
      { id: 'green', name: 'Vert', color: 0x00ff00, price: 200 }
    ];

    const shopBtn = document.getElementById('shopBtn');
    const shop = document.getElementById('shop');
    const skinsList = document.getElementById('skinsList');
    const closeShop = document.getElementById('closeShop');

    shopBtn.onclick = () => {
      if (this.gameOver) return;
      shop.style.display = 'block';
      skinsList.innerHTML = '';
      skins.forEach(s => {
        const owned = s.price === 0 || localStorage.getItem('nn_owned_' + s.id) === 'true';
        const isCurrent = this.currentSkin === s.id;
        let btnText = isCurrent ? 'Équipé' : owned ? 'Équiper' : `Acheter (${s.price})`;
        skinsList.innerHTML += `<p>${s.name} <button onclick="window.buySkin('${s.id}')">${btnText}</button></p>`;
      });
    };

    closeShop.onclick = () => shop.style.display = 'none';

    window.buySkin = (id) => {
      const s = skins.find(sk => sk.id === id);
      const owned = localStorage.getItem('nn_owned_' + id) === 'true';
      if (!owned && this.coins >= s.price) {
        this.coins -= s.price;
        localStorage.setItem('nn_coins', this.coins);
        localStorage.setItem('nn_owned_' + id, 'true');
        document.getElementById('coins').textContent = this.coins;
      }
      if (owned || s.price === 0) {
        this.currentSkin = id;
        localStorage.setItem('nn_skin', id);
        this.player.updateSkin(s.color);
      }
      shopBtn.click(); // refresh shop
    };
  }

  reset() {
    this.score = 0;
    this.gameOver = false;
    this.speed = 0.18;
    this.player.reset();
    this.obstacles.forEach(o => this.scene.remove(o.mesh));
    this.collectibles.forEach(c => this.scene.remove(c.mesh));
    this.particles.forEach(p => this.scene.remove(p));
    this.obstacles = [];
    this.collectibles = [];
    this.particles = [];
    document.getElementById('gameOver').style.display = 'none';
    document.getElementById('score').textContent = '0';
    this.animate();
  }

  animate() {
    if (this.gameOver) return;

    requestAnimationFrame(() => this.animate());

    const delta = this.clock.getDelta();

    this.player.update(delta, this.speed);
    this.track.update(this.speed, delta);

    // Génération variée d'obstacles (50% bas pour saut, 50% haut pour dodge)
    if (Math.random() < 0.04 + this.speed * 0.07) {
      const lane = Math.floor(Math.random() * 3) - 1;
      const type = Math.random() < 0.5 ? 'low' : 'high';
      this.obstacles.push(new Obstacle(this.scene, lane, type));
    }
    if (Math.random() < 0.03) {
      const lane = Math.floor(Math.random() * 3) - 1;
      this.collectibles.push(new Collectible(this.scene, lane));
    }

    // Update obstacles & collisions
    this.obstacles = this.obstacles.filter(o => {
      o.update(this.speed);
      if (this.player.checkCollision(o.mesh, o.type)) {
        document.getElementById('crashSound').play();
        this.endGame();
        return false;
      }
      if (o.mesh.position.z > 40) {
        this.scene.remove(o.mesh);
        return false;
      }
      return true;
    });

    // Update collectibles & particules
    this.collectibles = this.collectibles.filter(c => {
      c.update(this.speed);
      if (this.player.checkCollision(c.mesh)) {
        document.getElementById('collectSound').play();
        this.coins += 5; // +5 coins par pièce
        localStorage.setItem('nn_coins', this.coins);
        document.getElementById('coins').textContent = this.coins;
        this.createParticles(c.mesh.position);
        this.scene.remove(c.mesh);
        return false;
      }
      if (c.mesh.position.z > 40) {
        this.scene.remove(c.mesh);
        return false;
      }
      return true;
    });

    // Update particules
    this.particles.forEach(p => p.update(delta));
    this.particles = this.particles.filter(p => p.life > 0);

    this.score += this.speed * 150;
    document.getElementById('score').textContent = Math.floor(this.score);

    if (this.score > this.highScore) {
      this.highScore = Math.floor(this.score);
      localStorage.setItem('nn_high', this.highScore);
      document.getElementById('high').textContent = this.highScore;
    }

    this.speed += 0.00016;

    this.camera.position.x = this.player.mesh.position.x * 0.35;
    this.camera.position.z = this.player.mesh.position.z + 14;
    this.camera.lookAt(this.player.mesh.position.x, this.player.mesh.position.y + 3, this.player.mesh.position.z - 12);

    this.renderer.render(this.scene, this.camera);
  }

  createParticles(pos) {
    for (let i = 0; i < 20; i++) {
      this.particles.push(new Particle(this.scene, pos));
    }
  }

  endGame() {
    this.gameOver = true;
    document.getElementById('finalScore').textContent = `Score: ${Math.floor(this.score)}`;
    document.getElementById('gameOver').style.display = 'block';
  }
}

class Player {
  constructor(scene, skin) {
    this.group = new THREE.Group();
    // Corps
    const bodyGeo = new THREE.BoxGeometry(1.4, 1.6, 1.4);
    this.bodyMat = new THREE.MeshStandardMaterial({ color: 0xffea00, emissive: 0xffaa00, emissiveIntensity: 0.4 });
    this.body = new THREE.Mesh(bodyGeo, this.bodyMat);
    this.body.position.y = 0.8;
    this.group.add(this.body);

    // Tête
    const headGeo = new THREE.SphereGeometry(0.7, 16, 16);
    const headMat = new THREE.MeshStandardMaterial({ color: 0xffea00 });
    this.head = new THREE.Mesh(headGeo, headMat);
    this.head.position.y = 1.9;
    this.group.add(this.head);

    this.group.position.set(0, 1, 0);
    this.group.castShadow = true;
    scene.add(this.group);

    this.lane = 0;
    this.velocityY = 0;
    this.isJumping = false;

    this.updateSkin(skin);
  }

  reset() {
    this.group.position.set(0, 1, 0);
    this.lane = 0;
    this.velocityY = 0;
    this.isJumping = false;
  }

  jump() {
    if (!this.isJumping) {
      this.velocityY = 0.34;
      this.isJumping = true;
    }
  }

  update(delta, speed) {
    const targetX = this.lane * 3.5;
    this.group.position.x += (targetX - this.group.position.x) * 0.3;

    this.velocityY -= 0.02 * delta * 60;
    this.group.position.y += this.velocityY * delta * 60;

    if (this.group.position.y <= 1) {
      this.group.position.y = 1;
      this.velocityY = 0;
      this.isJumping = false;
    }

    this.group.position.z -= speed * 60 * delta;
  }

  checkCollision(other, type) {
    const dx = Math.abs(this.group.position.x - other.position.x);
    const dz = Math.abs(this.group.position.z - other.position.z);
    const dy = this.group.position.y - other.position.y;
    if (type === 'low' && this.isJumping && dy > 1.5) return false; // saut par-dessus low
    return dx < 1.7 && dy < 2.0 && dz < 1.7;
  }

  updateSkin(color) {
    this.bodyMat.color.setHex(color);
    this.head.material.color.setHex(color);
  }
}

class Track {
  constructor(scene) {
    this.scene = scene;
    this.parts = [];
    this.create();
  }

  create() {
    for (let i = -8; i < 40; i++) {
      const geo = new THREE.PlaneGeometry(15, 12);
      const mat = new THREE.MeshStandardMaterial({ color: 0x111122, roughness: 0.9 });
      const floor = new THREE.Mesh(geo, mat);
      floor.rotation.x = -Math.PI / 2;
      floor.position.set(0, 0, -i * 12);
      floor.receiveShadow = true;
      this.scene.add(floor);
      this.parts.push(floor);

      for (let side of [-1, 1]) {
        const railGeo = new THREE.BoxGeometry(1.4, 0.5, 12.5);
        const railMat = new THREE.MeshStandardMaterial({ color: 0x444466, metalness: 0.6 });
        const rail = new THREE.Mesh(railGeo, railMat);
        rail.position.set(side * 5.5, 0.25, -i * 12);
        this.scene.add(rail);
        this.parts.push(rail);
      }
    }
  }

  update(speed, delta) {
    this.parts.forEach(p => {
      p.position.z += speed * 60 * delta;
      if (p.position.z > 100) {
        p.position.z -= 580;
      }
    });
  }
}

class Obstacle {
  constructor(scene, lane, type) {
    let height = type === 'low' ? 1.5 : 3.5; // low jumpable, high dodge
    const geo = new THREE.BoxGeometry(3.0, height, 3.5);
    const mat = new THREE.MeshStandardMaterial({ color: 0xff0033, emissive: 0x880000 });
    this.mesh = new THREE.Mesh(geo, mat);
    this.mesh.position.set(lane * 3.5, height / 2, -100 - Math.random() * 80);
    this.mesh.castShadow = true;
    scene.add(this.mesh);
    this.type = type;
  }

  update(speed) {
    this.mesh.position.z += speed * 60;
  }
}

class Collectible {
  constructor(scene, lane) {
    const geo = new THREE.SphereGeometry(1.0, 24, 24);
    const mat = new THREE.MeshStandardMaterial({
      color: 0xffff00,
      emissive: 0xffff00,
      emissiveIntensity: 1.5,
      metalness: 0.5
    });
    this.mesh = new THREE.Mesh(geo, mat);
    this.mesh.position.set(lane * 3.5, 2.5 + Math.random() * 2, -110 - Math.random() * 90);
    scene.add(this.mesh);
  }

  update(speed) {
    this.mesh.position.z += speed * 60;
    this.mesh.rotation.y += 0.07;
  }
}

class Particle {
  constructor(scene, pos) {
    const geo = new THREE.SphereGeometry(0.15, 8, 8);
    const mat = new THREE.MeshBasicMaterial({ color: 0xffff00 });
    this.mesh = new THREE.Mesh(geo, mat);
    this.mesh.position.copy(pos);
    scene.add(this.mesh);

    this.vx = (Math.random() - 0.5) * 0.2;
    this.vy = Math.random() * 0.3 + 0.1;
    this.vz = (Math.random() - 0.5) * 0.2;
    this.life = 1;
  }

  update(delta) {
    this.mesh.position.x += this.vx;
    this.mesh.position.y += this.vy;
    this.mesh.position.z += this.vz;
    this.vy -= 0.02;
    this.life -= delta * 2;
    this.mesh.scale.set(this.life, this.life, this.life);
    if (this.life <= 0) this.scene.remove(this.mesh);
  }
}

// ────────────────────────────────────────────────
// LANCEMENT
// ────────────────────────────────────────────────

const game = new Game();
game.init();

window.addEventListener('resize', () => {
  game.camera.aspect = window.innerWidth / window.innerHeight;
  game.camera.updateProjectionMatrix();
  game.renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
