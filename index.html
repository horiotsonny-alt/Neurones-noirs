<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Neurones Noirs - Parkour</title>
  <style>
    body { margin:0; padding:0; background:#000; overflow:hidden; touch-action:none; font-family:Arial,sans-serif; }
    canvas { display:block; width:100vw; height:100vh; background:linear-gradient(#0a001a 0%, #1a0033 50%, #000 100%); }
    #ui { position:fixed; top:10px; left:10px; color:#0f0; font-size:20px; z-index:10; text-shadow:0 0 5px #0f0; pointer-events:none; }
    #shopBtn { position:fixed; top:10px; right:10px; padding:8px 16px; background:#00f; color:#fff; border:none; border-radius:8px; font-size:16px; z-index:10; cursor:pointer; }
    #shop { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.9); padding:30px; border:2px solid #0f0; border-radius:12px; color:#0f0; text-align:center; display:none; max-width:320px; z-index:20; box-shadow:0 0 20px #0f0; }
    #shop button { margin:8px; padding:10px 20px; background:#0f0; color:#000; border:none; border-radius:6px; font-size:16px; cursor:pointer; }
    #closeShop { background:#f00; color:#fff; }
    #skinPreview { width:80px; height:80px; margin:15px auto; border:3px solid #0f0; border-radius:50%; box-shadow:0 0 15px #0f0; }
    #joystick { position:fixed; bottom:40px; left:40px; width:120px; height:120px; background:rgba(255,255,255,0.15); border-radius:50%; z-index:5; touch-action:none; display:none; }
    #knob { width:60px; height:60px; background:rgba(0,255,0,0.4); border-radius:50%; position:absolute; top:30px; left:30px; transition:0.1s; }
    #jumpBtn { position:fixed; bottom:40px; right:40px; width:90px; height:90px; background:rgba(255,0,0,0.5); border:none; border-radius:50%; color:#fff; font-size:40px; z-index:5; touch-action:none; }
    #jumpBtn:active { transform:scale(0.92); background:rgba(255,0,0,0.8); }
    #gameOver { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); color:#f00; font-size:50px; text-shadow:0 0 10px #f00; display:none; z-index:15; pointer-events:none; }
  </style>
</head>
<body>

  <canvas id="c"></canvas>
  <div id="ui">Coins: <span id="coins">0</span> | Score: <span id="score">0</span></div>
  <button id="shopBtn">Skins</button>
  <div id="gameOver">GAME OVER</div>

  <div id="shop">
    <h2>Skins</h2>
    <div id="skinPreview"></div>
    <p>Actuel: <span id="skinName">Classique</span></p>
    <div id="skins"></div>
    <button id="closeShop">Fermer</button>
  </div>

  <div id="joystick"><div id="knob"></div></div>
  <button id="jumpBtn">↑</button>

<script>
// === CONFIG ===
const c = document.getElementById('c');
const ctx = c.getContext('2d');
c.width = window.innerWidth;
c.height = window.innerHeight;

let coins = localStorage.getItem('nn_coins') ? +localStorage.getItem('nn_coins') : 0;
let score = 0;
let currentSkin = localStorage.getItem('nn_skin') || 'classique';
let gameOver = false;
let speed = 5;
let gravity = 0.7;
let player = { x: 150, y: c.height - 180, w: 50, h: 80, vy: 0, lane: 1, skin: currentSkin };
let lanes = [c.width*0.25, c.width*0.5, c.width*0.75];
let obstacles = [];
let collectibles = [];
let lastGen = 0;

// Skins
const skins = [
  {id:'classique', name:'Classique', color:'#ff0', price:0},
  {id:'rouge', name:'Rouge', color:'#f00', price:30},
  {id:'bleu', name:'Bleu', color:'#00f', price:80},
  {id:'vert', name:'Cyber', color:'#0f0', price:150},
  {id:'violet', name:'Violet', color:'#a0f', price:300},
  {id:'or', name:'Or', color:'#ffd700', price:600}
];

// Update UI
document.getElementById('coins').textContent = coins;

// Joystick
const joy = document.getElementById('joystick');
const knob = document.getElementById('knob');
let joyTouchId = null;

joy.addEventListener('touchstart', e => {
  e.preventDefault();
  joyTouchId = e.changedTouches[0].identifier;
  joy.style.display = 'block';
});

joy.addEventListener('touchmove', e => {
  e.preventDefault();
  for (let touch of e.changedTouches) {
    if (touch.identifier === joyTouchId) {
      const rect = joy.getBoundingClientRect();
      const cx = rect.left + 60;
      const cy = rect.top + 60;
      let dx = touch.clientX - cx;
      let dy = touch.clientY - cy;
      let dist = Math.hypot(dx, dy);
      let maxDist = 60;
      if (dist > maxDist) { dx *= maxDist/dist; dy *= maxDist/dist; }
      knob.style.left = (30 + dx) + 'px';
      knob.style.top = (30 + dy) + 'px';

      if (Math.abs(dx) > 30) {
        let targetLane = player.lane + (dx > 0 ? 1 : -1);
        if (targetLane >= 0 && targetLane <= 2) player.lane = targetLane;
      }
    }
  }
});

joy.addEventListener('touchend', e => {
  e.preventDefault();
  for (let touch of e.changedTouches) {
    if (touch.identifier === joyTouchId) {
      joyTouchId = null;
      joy.style.display = 'none';
      knob.style.left = '30px';
      knob.style.top = '30px';
    }
  }
});

// Saut
document.getElementById('jumpBtn').addEventListener('touchstart', e => {
  e.preventDefault();
  if (player.y + player.h >= c.height - 100 && player.vy === 0) {
    player.vy = -15;
  }
});

// Shop
const shopBtn = document.getElementById('shopBtn');
const shop = document.getElementById('shop');
const skinsDiv = document.getElementById('skins');
const preview = document.getElementById('skinPreview');
const skinName = document.getElementById('skinName');

shopBtn.onclick = () => { shop.style.display = 'block'; updateShop(); };
document.getElementById('closeShop').onclick = () => shop.style.display = 'none';

function updateShop() {
  const cur = skins.find(s => s.id === currentSkin);
  preview.style.background = cur.color;
  skinName.textContent = cur.name;
  skinsDiv.innerHTML = '';
  skins.forEach(s => {
    let btnText = s.id === currentSkin ? '(Équipé)' : s.price === 0 ? 'Gratuit' : coins >= s.price ? `<button onclick="buy('${s.id}')">Acheter ${s.price}</button>` : `Bloqué (${s.price})`;
    skinsDiv.innerHTML += `<p style="color:${s.color}">${s.name} ${btnText}</p>`;
  });
}

window.buy = id => {
  const s = skins.find(s => s.id === id);
  if (coins >= s.price) {
    coins -= s.price;
    localStorage.setItem('nn_coins', coins);
    currentSkin = id;
    localStorage.setItem('nn_skin', id);
    player.skin = id;
    document.getElementById('coins').textContent = coins;
    updateShop();
  }
};

// Game loop
function loop() {
  if (gameOver) return;

  ctx.clearRect(0,0,c.width,c.height);

  // Scroll monde
  ctx.save();
  ctx.translate(-scrollOffset % 400, 0);

  // Sol
  ctx.fillStyle = '#111';
  ctx.fillRect(0, c.height - 100, c.width*10, 100);

  // Obstacles & pièces
  if (Date.now() - lastGen > 1000 / speed) {
    lastGen = Date.now();
    // Obstacle
    obstacles.push({x: c.width + scrollOffset + 100, y: c.height - 150, w: 60, h: 150});
    // Pièce
    if (Math.random() > 0.3) collectibles.push({x: c.width + scrollOffset + 250 + Math.random()*300, y: c.height - 200 - Math.random()*120, r: 18});
  }

  // Update joueur
  player.y += player.vy;
  player.vy += gravity;
  if (player.y + player.h > c.height - 100) {
    player.y = c.height - 100 - player.h;
    player.vy = 0;
  }
  player.x += (lanes[player.lane] - player.x) * 0.18; // smooth

  // Draw joueur
  ctx.fillStyle = skins.find(s => s.id === player.skin)?.color || '#ff0';
  ctx.fillRect(player.x, player.y, player.w, player.h);
  ctx.fillStyle = '#fff';
  ctx.fillRect(player.x + 15, player.y + 15, 8, 8); // œil

  // Draw obstacles
  ctx.fillStyle = '#c00';
  obstacles.forEach(o => ctx.fillRect(o.x - scrollOffset, o.y, o.w, o.h));

  // Draw collectibles
  ctx.fillStyle = '#ff0';
  collectibles.forEach(c => {
    ctx.beginPath();
    ctx.arc(c.x - scrollOffset, c.y, c.r, 0, Math.PI*2);
    ctx.fill();
    ctx.strokeStyle = '#ff8';
    ctx.lineWidth = 3;
    ctx.stroke();
  });

  ctx.restore();

  score += 1;
  document.getElementById('score').textContent = score;

  // Collision obstacle
  for (let o of obstacles) {
    if (player.x < o.x - scrollOffset + o.w && player.x + player.w > o.x - scrollOffset &&
        player.y < o.y + o.h && player.y + player.h > o.y) {
      gameOver = true;
      document.getElementById('gameOver').style.display = 'block';
      setTimeout(() => location.reload(), 1500);
    }
  }

  // Collectible
  for (let i = collectibles.length - 1; i >= 0; i--) {
    let co = collectibles[i];
    let dx = player.x + player.w/2 - (co.x - scrollOffset);
    let dy = player.y + player.h/2 - co.y;
    if (Math.hypot(dx, dy) < 45) {
      coins += 1;
      localStorage.setItem('nn_coins', coins);
      document.getElementById('coins').textContent = coins;
      collectibles.splice(i,1);
    }
  }

  scrollOffset += speed;
  speed += 0.0015;

  requestAnimationFrame(loop);
}

loop();

// Resize
window.addEventListener('resize', () => {
  c.width = window.innerWidth;
  c.height = window.innerHeight;
  lanes = [c.width*0.25, c.width*0.5, c.width*0.75];
});
</script>
</body>
</html>
